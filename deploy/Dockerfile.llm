# gpt-oss LLM Server Dockerfile (Large Model)
FROM vllm/vllm-openai:latest

WORKDIR /app

# Install special gpt-oss vLLM version
RUN pip install --upgrade pip && \
    pip install --pre vllm==0.10.1+gptoss \
    --extra-index-url https://wheels.vllm.ai/gpt-oss/ \
    --extra-index-url https://download.pytorch.org/whl/nightly/cu128

# Set environment variables
ENV CUDA_VISIBLE_DEVICES=0
ENV VLLM_WORKER_MULTIPROC_METHOD=spawn

# Expose port
EXPOSE 8000

# Pre-download gpt-oss model during build (for offline deployment)
ARG GPT_OSS_MODEL="openai/gpt-oss-20b"
ENV MODEL_NAME=${GPT_OSS_MODEL}

# Pre-download model during build
RUN python -c "
import os
from huggingface_hub import snapshot_download
model_name = os.environ.get('MODEL_NAME', 'openai/gpt-oss-20b')
print(f'Pre-downloading model: {model_name}')
try:
    snapshot_download(
        repo_id=model_name,
        cache_dir='/root/.cache/huggingface/hub',
        local_files_only=False,
        resume_download=True
    )
    print(f'Model {model_name} downloaded successfully')
except Exception as e:
    print(f'Error downloading model: {e}')
    exit(1)
"

# Create startup script without line continuations (single command line)
RUN printf '#!/bin/bash\nMODEL=${MODEL_NAME:-"openai/gpt-oss-20b"}\nTENSOR_PARALLEL=${TENSOR_PARALLEL:-1}\nGPU_MEMORY=${GPU_MEMORY:-0.8}\n\necho "Starting gpt-oss server with model: $MODEL"\necho "Model is pre-downloaded for offline deployment"\n\nvllm serve $MODEL --host 0.0.0.0 --port 8000 --tensor-parallel-size $TENSOR_PARALLEL --gpu-memory-utilization $GPU_MEMORY --trust-remote-code\n' > /app/start_gpt_oss.sh

RUN chmod +x /app/start_gpt_oss.sh

# Override the vLLM entrypoint
ENTRYPOINT []
CMD ["/app/start_gpt_oss.sh"]